---
title: "WQX Data Portal Exploration "
author: "Badhia Yunes Katz"
date: "January 2025"
# output: rmarkdown::github_document
---


```{r include=FALSE}
library(tidyverse)
library(dataRetrieval)
library(leaflet)
```

## Overview {.tabset}

On this markdown, data exploration will be done at a high level (and last 10 years only). The parameters of interest that were selected (for now) are: temperature, dissolved oxygen, turbidity and TSS.

The available databases on WQX are NWIS (USGS) and WQX(EPA). WQX is a data warehouse for water quality, biological, and physical data used by state environmental agencies, the EPA, other federal agencies, universities, private citizens, and others.

Note for pulling data: The WQP brings data from all these organizations together and provides it in a single format that has a more verbose output than NWIS. To get non-NWIS data, need to use CharacteristicName instead of parameter code.

```{r echo=TRUE}
klamath_data <- whatWQPdata(huc = "180102")

summary <- klamath_data |> 
  group_by(MonitoringLocationTypeName) |>   # Group by site type
  summarize(total_activities = sum(activityCount, na.rm = TRUE),
            total_results = sum(resultCount, na.rm = TRUE),
            site_count = n(),
            .groups = "drop")

print(summary)
```

### Temperature 

Table showing the total temperature records for each organization for every year

```{r, echo=FALSE, warning=FALSE}
huc_code <- "180102"  # Klamath Basin
temp <- "Temperature, water" 

years <- seq(2014, as.numeric(format(Sys.Date(), "%Y")))  # Change starting year as needed

yearly_agency_summary_temp <- data.frame()

for (year in years) {
  start_date <- paste0(year, "-01-01")
  end_date <- paste0(year, "-12-31")
  
  temperature_data <- readWQPdata(
    huc = huc_code,
    characteristicName = temp,
    startDateLo = start_date,
    startDateHi = end_date
  )

  temperature_data$ActivityStartDate <- as.Date(temperature_data$ActivityStartDate)
  
  yearly_summary_temp <- temperature_data |> 
    group_by(OrganizationIdentifier) |> 
    summarize(year = year,
              total_records = n(),
              .groups = "drop")
  
  # use code below if we want MonitoringLocationIdentifier
    # yearly_summary_temp <- temperature_data |> 
    # group_by(year = year, 
    #          OrganizationIdentifier, 
    #          MonitoringLocationIdentifier) |> 
    # summarize(
    #   total_records = n(),
    #   .groups = "drop")
  
  yearly_agency_summary_temp <- bind_rows(yearly_agency_summary_temp, yearly_summary_temp)
}

print(yearly_agency_summary_temp) #TODO add site name here too
```

```{r fig.width=10, fig.height=8, echo=FALSE}
ggplot(yearly_agency_summary_temp, aes(x = OrganizationIdentifier, y = total_records, fill = OrganizationIdentifier)) +
  geom_bar(stat = "identity") +
  facet_wrap(~year, scales = "free_y") +  # Facet by year, allowing different y-axis scales
  theme_minimal() +
  labs(
    title = "Total Water Temperature Records by Organization for Each Year",
    x = "Organization Identifier",
    y = "Total Records"
  ) +
    theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 8),  
    legend.text = element_text(size = 8), 
    legend.title = element_text(size = 10),  
    legend.key.size = unit(0.5, "cm")
  )
```

### Dissolved oxygen (DO)

Table showing the total DO records for each organization for every year

```{r, echo=FALSE, warning=FALSE}
huc_code <- "180102"  # Klamath Basin
do <- "Dissolved oxygen (DO)" 

years <- seq(2014, as.numeric(format(Sys.Date(), "%Y")))  # Change starting year as needed

yearly_agency_summary_do <- data.frame()

for (year in years) {
  start_date <- paste0(year, "-01-01")
  end_date <- paste0(year, "-12-31")
  
  do_data <- readWQPdata(
    huc = huc_code,
    characteristicName = do,
    startDateLo = start_date,
    startDateHi = end_date
  )

  do_data$ActivityStartDate <- as.Date(do_data$ActivityStartDate)
  
  yearly_summary_do <- do_data |> 
    group_by(OrganizationIdentifier) |> 
    summarize(year = year,
              total_records = n(),
              .groups = "drop")
  
  yearly_agency_summary_do <- bind_rows(yearly_agency_summary_do, yearly_summary_do)
}

print(yearly_agency_summary_do)
```
```{r fig.width=10, fig.height=8, echo=FALSE}
ggplot(yearly_agency_summary_do, aes(x = OrganizationIdentifier, y = total_records, fill = OrganizationIdentifier)) +
  geom_bar(stat = "identity") +
  facet_wrap(~year, scales = "free_y") +  # Facet by year, allowing different y-axis scales
  theme_minimal() +
  labs(
    title = "Total Water DO Records by Organization for Each Year",
    x = "Organization Identifier",
    y = "Total Records"
  ) +
    theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 8),  
    legend.text = element_text(size = 8), 
    legend.title = element_text(size = 10),  
    legend.key.size = unit(0.5, "cm")
  )
```

### Turbidity

Table showing the total turbidity records for each organization for every year

```{r, echo=FALSE, warning=FALSE}
huc_code <- "180102"  # Klamath Basin
turbidity <- "Turbidity" 

years <- seq(2014, as.numeric(format(Sys.Date(), "%Y")))  # Change starting year as needed

yearly_agency_summary_turbidity <- data.frame()

for (year in years) {
  start_date <- paste0(year, "-01-01")
  end_date <- paste0(year, "-12-31")
  
  turbidity_data <- readWQPdata(
    huc = huc_code,
    characteristicName = turbidity,
    startDateLo = start_date,
    startDateHi = end_date
  )

  turbidity_data$ActivityStartDate <- as.Date(turbidity_data$ActivityStartDate)
  
  yearly_summary_turbidity <- turbidity_data |> 
    group_by(OrganizationIdentifier) |> 
    summarize(year = year,
              total_records = n(),
              .groups = "drop")
  
  yearly_agency_summary_turbidity <- bind_rows(yearly_agency_summary_turbidity, yearly_summary_turbidity)
}

print(yearly_agency_summary_turbidity)
```

```{r fig.width=10, fig.height=8, echo=FALSE}
ggplot(yearly_agency_summary_turbidity, aes(x = OrganizationIdentifier, y = total_records, fill = OrganizationIdentifier)) +
  geom_bar(stat = "identity") +
  facet_wrap(~year, scales = "free_y") +  # Facet by year, allowing different y-axis scales
  theme_minimal() +
  labs(
    title = "Total Turbidity Records by Organization for Each Year",
    x = "Organization Identifier",
    y = "Total Records"
  ) +
    theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 8),  
    legend.text = element_text(size = 8), 
    legend.title = element_text(size = 10),  
    legend.key.size = unit(0.5, "cm")
  )
```

### Total suspended solids

Table showing the total Total suspended solids records for each organization for every year

```{r, echo=FALSE, warning=FALSE}
huc_code <- "180102"  # Klamath Basin
tss <- "Total suspended solids" 

years <- seq(2014, as.numeric(format(Sys.Date(), "%Y")))  # Change starting year as needed

yearly_agency_summary_tss <- data.frame()

for (year in years) {
  start_date <- paste0(year, "-01-01")
  end_date <- paste0(year, "-12-31")
  
  tss_data <- readWQPdata(
    huc = huc_code,
    characteristicName = tss,
    startDateLo = start_date,
    startDateHi = end_date
  )

  tss_data$ActivityStartDate <- as.Date(tss_data$ActivityStartDate)
  
  yearly_summary_tss <- tss_data |> 
    group_by(OrganizationIdentifier) |> 
    summarize(year = year,
              total_records = n(),
              .groups = "drop")
  
  yearly_agency_summary_tss <- bind_rows(yearly_agency_summary_tss, yearly_summary_tss)
}

print(yearly_agency_summary_tss)
```

```{r fig.width=10, fig.height=8, echo=FALSE}
ggplot(yearly_agency_summary_tss, aes(x = OrganizationIdentifier, y = total_records, fill = OrganizationIdentifier)) +
  geom_bar(stat = "identity") +
  facet_wrap(~year, scales = "free_y") +  # Facet by year, allowing different y-axis scales
  theme_minimal() +
  labs(
    title = "Total Total suspended solids Records by Organization for Each Year",
    x = "Organization Identifier",
    y = "Total Records"
  ) +
    theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 8),  
    legend.text = element_text(size = 8), 
    legend.title = element_text(size = 10),  
    legend.key.size = unit(0.5, "cm")
  )
```

# Test Code
```{r}
huc_code <- "180102"  # Klamath Basin
temp <- "Temperature, water" 

years <- seq(2014, as.numeric(format(Sys.Date(), "%Y")))  # Change starting year as needed

yearly_agency_summary_temp <- data.frame()


for (year in years) {
  start_date <- paste0(year, "-01-01")
  end_date <- paste0(year, "-12-31")
  
  temperature_data <- readWQPdata(
    huc = huc_code,
    characteristicName = temp,
    startDateLo = start_date,
    startDateHi = end_date
  )

  temperature_data$ActivityStartDate <- as.Date(temperature_data$ActivityStartDate)
  
  # use code below if we want MonitoringLocationIdentifier
    yearly_summary_temp <- temperature_data |>
    group_by(year = year,
             OrganizationIdentifier,
             MonitoringLocationIdentifier) |>
    summarize(
      total_records = n(),
      .groups = "drop")
  
  yearly_agency_summary_temp <- bind_rows(yearly_agency_summary_temp, yearly_summary_temp)
}

url_call <- paste0('https://www.waterqualitydata.us/Result/search?huc=', huc_code, '&mimeType=tsv&sorted=no')

url_station <- gsub("/Result/", "/Station/", url_call)

site_info <- importWQP(url_station, FALSE, tz="") |>
  janitor::clean_names() |> 
  select(monitoring_location_identifier, huc_eight_digit_code, latitude_measure, longitude_measure)


# join 
all_temp_data <- yearly_agency_summary_temp |> 
  janitor::clean_names() |> 
  left_join(site_info) |> 
  mutate(latitude_measure = as.numeric(latitude_measure),
         longitude_measure = as.numeric(longitude_measure)) |> 
  glimpse()


print(all_temp_data)
```

```{r}
# Here's an example of how we can do the data overview per parameter (?)

# this could serve as an overview of what fields are included when pulling (1) site data and (2) actual data pull
huc_code <- "180102"
characteristic_name <- "Temperature, water"
start_date <- "2014-01-01"  
end_date <- "2024-12-31"    

# (1) station/site information 
stations <- whatWQPsites(huc = huc_code, characteristicName = characteristic_name)
colnames(stations)
# (2) actual water temperature data for the 10 year period
temperature_data <- readWQPdata(
  huc = huc_code,
  characteristicName = characteristic_name,
  startDateLo = start_date,
  startDateHi = end_date
)

colnames(temperature_data)
# using the "MonitoringLocationIdentifier" as the key - here's where we can keep just the fields that we want

merged_data <- merge(temperature_data, stations, by = "MonitoringLocationIdentifier")

# ---- here I am trying to get an overview of what parameters (characteristicName) are available, will pull 1 year's data as a sample

# Get metadata for all water quality data available for the specified HUC
wqp_metadata <- readWQPdata(huc = huc_code, startDateLo = "2014-01-01",
  startDateHi = "2014-12-31")

# Extract unique characteristic names
characteristic_names <- unique(wqp_metadata$CharacteristicName)

# Display the unique characteristic names
print(characteristic_names)
```


```{r}

# klamath_huc <- "180102"  # Klamath Basin
# temp <- "Temperature, water" 
# 
# years <- seq(2014, as.numeric(format(Sys.Date(), "%Y")))  # Change starting year as needed
# 
# yearly_agency_summary_temp <- data.frame()
# 
# 
# temperature_data <- readWQPdata(huc = klamath_huc,                       
#   characteristicName = "Temperature, water",
#   startDateLo = "2024-01-01",               
#   startDateHi = Sys.Date()                  
# )
```


---- Maddee's code below, keeping for reference for now ----

```{r include=FALSE}
col_select <- function(data) {
  data |> 
    janitor::clean_names() 
    # select(organization_identifier,
    #        organization_formal_name,
    #        activity_media_name,
    #        activity_media_subdivision_name,
    #        activity_start_date,
    #        activity_start_time_time,
    #        activity_start_time_time_zone_code,
    #        activity_end_date,
    #        activity_end_time_time,
    #        activity_end_time_time_zone_code,
    #        monitoring_location_identifier,
    #        characteristic_name,
    #        result_sample_fraction_text,
    #        result_measure_value,
    #        result_measure_measure_unit_code,
    #        result_status_identifier,
    #        result_analytical_method_method_name,
    #        provider_name)
}


# Define the Klamath River watershed HUC
klamath_huc <- "180102"

storet_query <- list(
  huc = klamath_huc,                       
  characteristicName = c(
    "Temperature, water",
    "Dissolved oxygen (DO)",
    "Turbidity",
    "Total suspended solids"
  ),
  startDateLo = "2024-01-01",               
  startDateHi = Sys.Date()                  
)


# Retrieve STORET data
storet_data <- readWQPdata(storet_query)

storet_data_clean <- storet_data |> col_select()

storet_data_clean |> glimpse()

unique(storet_data_clean$characteristic_name)

# get lat/longs
url_call <- paste0('https://www.waterqualitydata.us/Result/search?huc=', klamath_huc, '&mimeType=tsv&sorted=no')

url_station <- gsub("/Result/", "/Station/", url_call)

site_info <- importWQP(url_station, FALSE, tz="") |>
  janitor::clean_names() |> glimpse()
  # select(monitoring_location_identifier, huc_eight_digit_code, latitude_measure, longitude_measure)


# join 
all_storet_data <- storet_data_clean |> left_join(site_info) |> 
  mutate(latitude_measure = as.numeric(latitude_measure),
         longitude_measure = as.numeric(longitude_measure)) |> 
  glimpse()

temp_storet <- all_storet_data |> 
  filter(characteristic_name == "Temperature, water") |> 
  glimpse()
```


```{r, echo=FALSE}
# visualize 
leaflet(data = all_storet_data)  |> 
  addTiles()  |> 
  addCircleMarkers(
    ~longitude_measure, ~latitude_measure,
    popup = ~paste0("<br><b>Latitude: </b>", latitude_measure, 
                    "<br><b>Longitude: </b>", longitude_measure,
                    "<br><b>Characteristic Name: </b>", characteristic_name),
    fillOpacity = 0.7,
    radius = 5
  ) 
```

